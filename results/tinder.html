<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hyper-Entity Tinder</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }
        .progress-bar {
            width: 100%;
            max-width: 600px;
            height: 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            margin-bottom: 10px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00d4ff, #7b2cbf);
            transition: width 0.3s ease;
        }
        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            font-size: 14px;
            color: rgba(255,255,255,0.7);
        }
        .stats span { display: flex; align-items: center; gap: 5px; }
        .starred-count { color: #ffd700; }
        .save-btn {
            background: linear-gradient(135deg, #00d4ff, #7b2cbf);
            color: white;
            border: none;
            padding: 6px 14px;
            font-size: 13px;
            border-radius: 15px;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        .save-btn:hover { opacity: 0.85; }
        .card-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            min-height: 500px;
        }
        .card {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 30px;
            backdrop-filter: blur(10px);
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        .card.swiping-left { transform: translateX(-150%) rotate(-20deg); opacity: 0; }
        .card.swiping-right { transform: translateX(150%) rotate(20deg); opacity: 0; }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }
        .entity-name {
            font-size: 24px;
            font-weight: 600;
            line-height: 1.3;
            flex: 1;
        }
        .scores {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
            margin-left: 15px;
        }
        .score-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        .tech-score { background: linear-gradient(135deg, #7b2cbf, #c77dff); }
        .dacc-score { background: linear-gradient(135deg, #00b4d8, #0077b6); }
        .cluster-tag {
            display: inline-block;
            background: rgba(255,255,255,0.1);
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            margin-bottom: 15px;
            color: rgba(255,255,255,0.8);
        }
        .description {
            font-size: 16px;
            line-height: 1.6;
            color: rgba(255,255,255,0.9);
            margin-bottom: 20px;
        }
        .details { margin-bottom: 20px; }
        .detail-section {
            margin-bottom: 15px;
        }
        .detail-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: rgba(255,255,255,0.5);
            margin-bottom: 5px;
        }
        .detail-text {
            font-size: 14px;
            line-height: 1.5;
            color: rgba(255,255,255,0.8);
        }
        .tech-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }
        .tech-tag {
            background: linear-gradient(135deg, #2d3436, #636e72);
            padding: 6px 14px;
            border-radius: 16px;
            font-size: 13px;
            color: #dfe6e9;
        }
        .buttons {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 30px;
        }
        .btn {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            font-size: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .btn:hover { transform: scale(1.1); }
        .btn:active { transform: scale(0.95); }
        .btn-skip {
            background: linear-gradient(135deg, #444, #666);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .btn-star {
            background: linear-gradient(135deg, #ffd700, #ffaa00);
            box-shadow: 0 4px 15px rgba(255,215,0,0.4);
        }
        .btn-back {
            background: linear-gradient(135deg, #555, #777);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            width: 50px;
            height: 50px;
            font-size: 20px;
        }
        .keyboard-hints {
            margin-top: 20px;
            font-size: 12px;
            color: rgba(255,255,255,0.4);
        }
        .done-screen {
            text-align: center;
            padding: 60px 30px;
        }
        .done-screen h2 { font-size: 32px; margin-bottom: 20px; }
        .done-screen p { margin-bottom: 30px; color: rgba(255,255,255,0.7); }
        .export-btn {
            background: linear-gradient(135deg, #00d4ff, #7b2cbf);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 16px;
            border-radius: 30px;
            cursor: pointer;
            margin: 10px;
        }
        .export-btn:hover { opacity: 0.9; }
        .restart-btn {
            background: rgba(255,255,255,0.1);
            color: white;
            border: 1px solid rgba(255,255,255,0.2);
            padding: 15px 40px;
            font-size: 16px;
            border-radius: 30px;
            cursor: pointer;
            margin: 10px;
        }
        .starred-list {
            max-width: 600px;
            width: 100%;
            margin-top: 30px;
            text-align: left;
        }
        .starred-list h3 { margin-bottom: 15px; }
        .starred-item {
            background: rgba(255,255,255,0.05);
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .starred-item .name { flex: 1; }
        .starred-item .score {
            color: #c77dff;
            font-size: 14px;
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <div class="progress-bar">
        <div class="progress-fill" id="progress"></div>
    </div>
    <div class="stats">
        <span id="counter">0 / 0</span>
        <span class="starred-count" id="starred-count">0 starred</span>
        <button class="save-btn" onclick="exportJSON()" title="Save starred entities to JSON">ðŸ’¾ Save</button>
    </div>

    <div class="card-container" id="card-container">
        <div class="card" id="card">Loading...</div>
    </div>

    <div class="buttons" id="buttons">
        <button class="btn btn-back" onclick="goBack()" title="Go back (B)">&#8592;</button>
        <button class="btn btn-skip" onclick="skip()" title="Skip (Left arrow)">&#10005;</button>
        <button class="btn btn-star" onclick="star()" title="Star (Right arrow)">&#9733;</button>
    </div>

    <div class="keyboard-hints">
        &#8592; Skip &nbsp;&nbsp;|&nbsp;&nbsp; &#8594; Star &nbsp;&nbsp;|&nbsp;&nbsp; B = Back &nbsp;&nbsp;|&nbsp;&nbsp; S = Save
    </div>

    <script>
        let entities = [];
        let currentIndex = 0;
        let starred = new Set();
        let history = [];

        // Load data
        fetch('stage3_concrete/entities.json')
            .then(r => r.json())
            .then(data => {
                entities = data.entities
                    .sort((a, b) => (b.stage3_dacc?.total ?? 0) - (a.stage3_dacc?.total ?? 0));

                // Load saved progress
                const saved = localStorage.getItem('hyper-entity-tinder');
                if (saved) {
                    const state = JSON.parse(saved);
                    currentIndex = state.currentIndex || 0;
                    starred = new Set(state.starred || []);
                    history = state.history || [];
                }

                render();
            });

        function save() {
            localStorage.setItem('hyper-entity-tinder', JSON.stringify({
                currentIndex,
                starred: [...starred],
                history
            }));
        }

        function render() {
            if (currentIndex >= entities.length) {
                showDone();
                return;
            }

            const e = entities[currentIndex];
            const daccTotal = e.stage3_dacc?.total ?? 'N/A';

            document.getElementById('card').innerHTML = `
                <div class="card-header">
                    <div class="entity-name">${e.name}</div>
                    <div class="scores">
                        <span class="score-badge dacc-score">d/acc: ${daccTotal}/20</span>
                        <span class="score-badge tech-score">Tech: ${e.stage2_total ?? 'N/A'}/70</span>
                    </div>
                </div>
                <div class="cluster-tag">${e.cluster_name || e.category || 'Uncategorized'}</div>
                <div class="description">${e.description || 'No description available.'}</div>
                <div class="details">
                    ${e.concreteness?.core_technologies?.length ? `
                        <div class="detail-section">
                            <div class="detail-label">Core Technologies</div>
                            <div class="tech-tags">
                                ${e.concreteness.core_technologies.map(t => `<span class="tech-tag">${t}</span>`).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;

            document.getElementById('progress').style.width =
                `${(currentIndex / entities.length) * 100}%`;
            document.getElementById('counter').textContent =
                `${currentIndex + 1} / ${entities.length}`;
            document.getElementById('starred-count').textContent =
                `${starred.size} starred`;

            document.getElementById('buttons').style.display = 'flex';
            document.querySelector('.keyboard-hints').style.display = 'block';
        }

        function truncate(text, len) {
            if (!text) return '';
            return text.length > len ? text.substring(0, len) + '...' : text;
        }

        function skip() {
            if (currentIndex >= entities.length) return;
            history.push({ index: currentIndex, action: 'skip' });
            animateSwipe('left');
        }

        function star() {
            if (currentIndex >= entities.length) return;
            starred.add(entities[currentIndex].id);
            history.push({ index: currentIndex, action: 'star' });
            animateSwipe('right');
        }

        function animateSwipe(direction) {
            const card = document.getElementById('card');
            card.classList.add(`swiping-${direction}`);
            setTimeout(() => {
                card.classList.remove(`swiping-${direction}`);
                currentIndex++;
                save();
                render();
            }, 300);
        }

        function goBack() {
            if (history.length === 0) return;
            const last = history.pop();
            currentIndex = last.index;
            if (last.action === 'star') {
                starred.delete(entities[last.index].id);
            }
            save();
            render();
        }

        function showDone() {
            const starredEntities = entities.filter(e => starred.has(e.id));

            document.getElementById('card-container').innerHTML = `
                <div class="done-screen">
                    <h2>All done!</h2>
                    <p>You reviewed ${entities.length} entities and starred ${starred.size}.</p>
                    <button class="export-btn" onclick="exportCSV()">Export CSV</button>
                    <button class="export-btn" onclick="exportJSON()">Export JSON</button>
                    <button class="restart-btn" onclick="restart()">Start Over</button>
                </div>
                <div class="starred-list">
                    <h3>Starred Entities</h3>
                    ${starredEntities.map(e => `
                        <div class="starred-item">
                            <span class="name">${e.name}</span>
                            <span class="score">${e.stage2_total}/70</span>
                        </div>
                    `).join('')}
                </div>
            `;
            document.getElementById('buttons').style.display = 'none';
            document.querySelector('.keyboard-hints').style.display = 'none';
        }

        function exportCSV() {
            const starredEntities = entities.filter(e => starred.has(e.id));
            const csv = 'Name,Tech Score,d/acc Score,Cluster,Description\n' +
                starredEntities.map(e =>
                    `"${e.name}",${e.stage2_total},${e.stage3_dacc?.total ?? ''},` +
                    `"${e.cluster_name || ''}","${(e.description || '').replace(/"/g, '""')}"`
                ).join('\n');
            download(csv, 'starred-entities.csv', 'text/csv');
        }

        function exportJSON() {
            const starredEntities = entities.filter(e => starred.has(e.id));
            download(JSON.stringify(starredEntities, null, 2), 'starred-entities.json', 'application/json');
        }

        function download(content, filename, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
        }

        function restart() {
            if (confirm('This will clear all progress and starred items. Continue?')) {
                currentIndex = 0;
                starred = new Set();
                history = [];
                save();
                location.reload();
            }
        }

        // Keyboard controls
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft') skip();
            else if (e.key === 'ArrowRight') star();
            else if (e.key.toLowerCase() === 'b') goBack();
            else if (e.key.toLowerCase() === 's') exportJSON();
        });
    </script>
</body>
</html>
